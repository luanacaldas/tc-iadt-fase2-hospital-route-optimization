<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rastreamento em Tempo Real - MapBox</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ============================================
       DESIGN SYSTEM - VARI√ÅVEIS CSS
       ============================================ */
    :root {
      /* Tipografia */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-size-xs: 11px;
      --font-size-sm: 12px;
      --font-size-base: 14px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;

      /* Pesos */
      --font-normal: 400;
      --font-medium: 500;
      --font-semibold: 600;
      --font-bold: 700;

      /* Cores Neutras */
      --color-white: #FFFFFF;
      --color-gray-50: #F9FAFB;
      --color-gray-100: #F3F4F6;
      --color-gray-200: #E5E7EB;
      --color-gray-300: #D1D5DB;
      --color-gray-400: #9CA3AF;
      --color-gray-500: #6B7280;
      --color-gray-600: #4B5563;
      --color-gray-700: #374151;
      --color-gray-800: #1F2937;
      --color-gray-900: #111827;

      /* Cores Sem√¢nticas */
      --color-primary: #2563EB;
      --color-primary-hover: #1D4ED8;
      --color-success: #10B981;
      --color-warning: #F59E0B;
      --color-danger: #EF4444;

      /* Espa√ßamento */
      --spacing-1: 4px;
      --spacing-2: 8px;
      --spacing-3: 12px;
      --spacing-4: 16px;
      --spacing-5: 20px;
      --spacing-6: 24px;
      --spacing-8: 32px;

      /* Bordas */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;

      /* Sombras */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      background: var(--color-gray-50);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 1rem;
      height: calc(100vh - 74px);
      /* Ajustado para o header */
      padding: 1rem;
    }

    #map {
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .sidebar {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* ============================================
       HEADER PROFISSIONAL - 3 SE√á√ïES
       ============================================ */
    .tracking-header {
      background: var(--color-white);
      border-bottom: 1px solid var(--color-gray-200);
      padding: var(--spacing-4) var(--spacing-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-6);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    /* SE√á√ÉO 1: BRANDING (Esquerda) */
    .header-brand {
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
      flex-shrink: 0;
    }

    .brand-icon {
      font-size: 24px;
      line-height: 1;
    }

    .brand-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-bold);
      color: var(--color-gray-900);
      letter-spacing: -0.01em;
      line-height: 1.2;
    }

    .brand-subtitle {
      font-size: var(--font-size-xs);
      font-weight: var(--font-normal);
      color: var(--color-gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Divider Vertical */
    .header-divider {
      width: 1px;
      height: 40px;
      background: linear-gradient(to bottom,
          transparent 0%,
          var(--color-gray-200) 20%,
          var(--color-gray-200) 80%,
          transparent 100%);
      flex-shrink: 0;
    }

    /* SE√á√ÉO 2: KPIs E M√âTRICAS (Centro) */
    .header-metrics {
      display: flex;
      align-items: center;
      gap: var(--spacing-5);
      flex: 1;
      justify-content: center;
    }

    .metric-card {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: var(--spacing-2) var(--spacing-4);
      background: var(--color-gray-50);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      min-width: 100px;
    }

    .metric-card:hover {
      background: var(--color-white);
      border-color: var(--color-primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .metric-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-normal);
      color: var(--color-gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .metric-label-icon {
      font-size: 10px;
      opacity: 0.7;
    }

    .metric-value {
      font-size: var(--font-size-lg);
      font-weight: var(--font-bold);
      color: var(--color-gray-900);
      line-height: 1;
      letter-spacing: -0.02em;
    }

    .metric-value.status-active {
      color: var(--color-success);
    }

    .metric-value.status-alert {
      color: var(--color-danger);
    }

    /* SE√á√ÉO 3: A√á√ïES (Direita) */
    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
      flex-shrink: 0;
    }

    .btn-header {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-2);
      padding: var(--spacing-2) var(--spacing-4);
      font-size: var(--font-size-sm);
      font-weight: var(--font-medium);
      font-family: var(--font-family);
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      white-space: nowrap;
      letter-spacing: -0.01em;
    }

    .btn-header-ghost {
      background: transparent;
      color: var(--color-gray-600);
      border: 1px solid var(--color-gray-300);
    }

    .btn-header-ghost:hover {
      background: var(--color-gray-100);
      color: var(--color-gray-900);
      border-color: var(--color-gray-400);
    }

    .btn-header-primary {
      background: var(--color-primary);
      color: var(--color-white);
      border: 1px solid var(--color-primary);
    }

    .btn-header-primary:hover {
      background: var(--color-primary-hover);
      border-color: var(--color-primary-hover);
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .btn-header-icon {
      font-size: 14px;
      line-height: 1;
    }

    /* Responsividade do Header */
    @media (max-width: 1024px) {
      .tracking-header {
        gap: var(--spacing-4);
      }

      .header-metrics {
        gap: var(--spacing-3);
      }

      .metric-card {
        min-width: 80px;
        padding: var(--spacing-2) var(--spacing-3);
      }
    }

    @media (max-width: 768px) {
      .tracking-header {
        flex-wrap: wrap;
        padding: var(--spacing-3) var(--spacing-4);
      }

      .header-divider {
        display: none;
      }

      .header-metrics {
        order: 3;
        width: 100%;
        justify-content: flex-start;
        overflow-x: auto;
        padding-top: var(--spacing-3);
        border-top: 1px solid var(--color-gray-200);
      }

      .btn-header span:not(.btn-header-icon) {
        display: none;
      }
    }

    .vehicle-card {
      background: #f8fafc;
      border-left: 4px solid;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }

    .vehicle-card.blue {
      border-left-color: #2563eb;
    }

    .vehicle-card.red {
      border-left-color: #ef4444;
    }

    .vehicle-card.green {
      border-left-color: #10b981;
    }

    .vehicle-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .vehicle-icon {
      font-size: 1.5rem;
    }

    .vehicle-name {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .vehicle-info {
      font-size: 0.75rem;
      line-height: 1.6;
      margin-bottom: 0.5rem;
    }

    .vehicle-info div {
      margin-bottom: 0.25rem;
    }

    .progress-bar {
      background: #e5e7eb;
      border-radius: 8px;
      height: 24px;
      position: relative;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-fill {
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      height: 100%;
      transition: width 0.3s;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.75rem;
      font-weight: 600;
      color: #1e293b;
    }

    .controls {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.4rem 0.75rem;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1e40af;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #1e293b;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .action-buttons {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
      padding: 0.6rem;
    }

    .status-active {
      color: #10b981;
      font-weight: 600;
    }

    .status-stopped {
      color: #64748b;
    }

    /* ============================================
       NOTIFICA√á√ïES TOAST
       ============================================ */
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* ============================================
       RESPONSIVIDADE MOBILE
       ============================================ */
    @media (max-width: 768px) {
      .tracking-header {
        flex-direction: column;
        gap: 12px;
        padding: 12px;
      }

      .brand-title {
        font-size: 16px;
      }

      .header-metrics {
        order: 3;
        width: 100%;
        justify-content: flex-start;
        overflow-x: auto;
        padding-top: 12px;
        border-top: 1px solid var(--color-gray-200);
      }

      .header-actions {
        width: 100%;
        justify-content: space-between;
      }

      .container {
        grid-template-columns: 1fr;
        grid-template-rows: 60vh auto;
        height: calc(100vh - 130px);
        padding: 0.5rem;
        gap: 0.5rem;
      }

      .sidebar {
        max-height: 40vh;
        order: 2;
      }

      #map {
        order: 1;
        min-height: 60vh;
      }

      .vehicle-card {
        padding: 0.75rem;
      }

      .btn-header span:not(.btn-header-icon) {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- Header Profissional com 3 Se√ß√µes -->
  <header class="tracking-header">
    <!-- Se√ß√£o 1: Branding (Esquerda) -->
    <div class="header-brand">
      <div class="brand-icon">üì°</div>
      <div class="brand-content">
        <div class="brand-title">Rotas Hospitalares</div>
        <div class="brand-subtitle">Rastreamento em Tempo Real</div>
      </div>
    </div>

    <!-- Divider -->
    <div class="header-divider"></div>

    <!-- Se√ß√£o 2: KPIs e M√©tricas (Centro) -->
    <div class="header-metrics" id="header-metrics">
      <!-- Preenchido via JavaScript -->
    </div>

    <!-- Divider -->
    <div class="header-divider"></div>

    <!-- Se√ß√£o 3: A√ß√µes (Direita) -->
    <div class="header-actions">
      <!-- MELHORIA 4: Controle de Velocidade -->
      <div style="position: relative; margin-right: 8px;">
        <select id="speedControl" onchange="changeSimulationSpeed(this.value)" style="
          padding: 8px 32px 8px 12px;
          border: 1px solid var(--color-gray-300);
          border-radius: 6px;
          font-size: 13px;
          font-weight: 500;
          color: var(--color-gray-900);
          background: white;
          cursor: pointer;
          appearance: none;
          font-family: var(--font-family);
        ">
          <option value="0.5">‚ö° 0.5x</option>
          <option value="1" selected>‚ö° 1x</option>
          <option value="2">‚ö° 2x</option>
          <option value="5">‚ö° 5x</option>
          <option value="10">‚ö° 10x</option>
        </select>
        <div style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--color-gray-400); font-size: 10px;">‚ñº</div>
      </div>
      <button class="btn-header btn-header-ghost" onclick="resetView()" title="Centralizar Mapa">
        <span class="btn-header-icon">üéØ</span>
        <span>Centralizar</span>
      </button>
      <button class="btn-header btn-header-primary" onclick="toggleTracking()" id="tracking-btn">
        <span class="btn-header-icon">‚ñ∂Ô∏è</span>
        <span>Iniciar</span>
      </button>
    </div>
  </header>

  <script>
    // ============================================
    // MELHORIA 4: CONTROLE DE VELOCIDADE
    // ============================================
    function changeSimulationSpeed(multiplier) {
      const speed = parseFloat(multiplier);
      state.vehicles.forEach(vehicle => {
        if (vehicle.speed > 0) {
          vehicle.speed = vehicle.baseSpeed * speed;
        }
      });
      showNotification(`‚ö° Velocidade ajustada para ${multiplier}x`, 'info');
    }
  </script>

  <div class="container">
    <div id="map"></div>
    <div class="sidebar" id="sidebar">
      <!-- Conte√∫do gerado via JavaScript -->
    </div>
  </div>

  <script>
    // Estado global
    const state = {
      vehicles: [
        {
          id: 1, color: 'blue', icon: 'üöô',
          currentStopIndex: 0, progressInRoute: 0, speed: 45, baseSpeed: 45,
          stops: [
            { name: 'Hospital das Cl√≠nicas', dist: 2.1, coords: [-46.6708, -23.5646] },
            { name: 'Hospital Einstein', dist: 3.2, coords: [-46.6750, -23.5990] },
            { name: 'Hospital S√≠rio-Liban√™s', dist: 1.8, coords: [-46.6532, -23.5673] }
          ],
          currentCoords: [-46.6708, -23.5646]
        },
        {
          id: 2, color: 'red', icon: 'üöó',
          currentStopIndex: 0, progressInRoute: 0, speed: 35, baseSpeed: 35,
          stops: [
            { name: 'Hospital Israelita', dist: 4.5, coords: [-46.6886, -23.5893] },
            { name: 'S√≠rio-Liban√™s', dist: 2.3, coords: [-46.6532, -23.5673] },
            { name: 'Hospital Alem√£o', dist: 3.1, coords: [-46.6610, -23.5987] }
          ],
          currentCoords: [-46.6886, -23.5893]
        },
        {
          id: 3, color: 'green', icon: 'üöê',
          currentStopIndex: 0, progressInRoute: 0, speed: 0, baseSpeed: 40,
          stops: [
            { name: 'Santa Casa', dist: 5.2, coords: [-46.6389, -23.5383] },
            { name: 'Hospital S√£o Paulo', dist: 2.8, coords: [-46.6422, -23.5980] },
            { name: 'Hospital 9 de Julho', dist: 4.1, coords: [-46.6681, -23.5533] }
          ],
          currentCoords: [-46.6389, -23.5383]
        }
      ],
      map: null,
      markers: {},
      isActive: false,
      interval: null,
      lastRender: null
    };

    // Inicializar MapBox
    mapboxgl.accessToken = 'pk.eyJ1IjoibHVhbmFjYWxkYSIsImEiOiJjbWtlemg0NnkwYzZ5M2twdzNjcGpxcnVnIn0.VrJwiBdO8u3V0J1gJqKFgg';

    state.map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-46.6611, -23.5705],
      zoom: 12
    });

    state.map.addControl(new mapboxgl.NavigationControl());

    // Aguardar mapa carregar completamente para adicionar rotas, hospitais e trails
    state.map.on('load', () => {
      drawRoutes();
      addHospitalMarkers();
      initializeTrails();
    });

    // ============================================
    // MELHORIA 1: DESENHAR ROTAS NO MAPA
    // ============================================
    function drawRoutes() {
      state.vehicles.forEach(vehicle => {
        const routeCoords = vehicle.stops.map(stop => stop.coords);

        // Adicionar source da rota
        state.map.addSource(`route-${vehicle.id}`, {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: {
              type: 'LineString',
              coordinates: routeCoords
            }
          }
        });

        // Adicionar layer da rota
        state.map.addLayer({
          id: `route-layer-${vehicle.id}`,
          type: 'line',
          source: `route-${vehicle.id}`,
          paint: {
            'line-color': vehicle.color === 'blue' ? '#2563eb' :
              vehicle.color === 'red' ? '#ef4444' : '#10b981',
            'line-width': 4,
            'line-opacity': 0.6
          }
        });
      });
    }

    // ============================================
    // MELHORIA 2: MARCADORES DOS HOSPITAIS
    // ============================================
    function addHospitalMarkers() {
      const addedCoords = new Set(); // Evitar duplicatas

      state.vehicles.forEach(vehicle => {
        vehicle.stops.forEach(stop => {
          const coordKey = `${stop.coords[0]},${stop.coords[1]}`;

          if (!addedCoords.has(coordKey)) {
            addedCoords.add(coordKey);

            // Criar elemento HTML para o marcador
            const el = document.createElement('div');
            el.innerHTML = 'üè•';
            el.style.cssText = `
                            font-size: 28px;
                            cursor: pointer;
                            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
                            transition: transform 0.2s;
                        `;

            // Efeito hover
            el.addEventListener('mouseenter', () => el.style.transform = 'scale(1.2)');
            el.addEventListener('mouseleave', () => el.style.transform = 'scale(1)');

            // Adicionar marcador ao mapa
            new mapboxgl.Marker(el)
              .setLngLat(stop.coords)
              .setPopup(
                new mapboxgl.Popup({ offset: 25 })
                  .setHTML(`<strong>üìç ${stop.name}</strong>`)
              )
              .addTo(state.map);
          }
        });
      });
    }

    // ============================================
    // MELHORIA 6: RASTRO/TRAIL DOS VE√çCULOS
    // ============================================
    function initializeTrails() {
      state.vehicles.forEach(vehicle => {
        const trailId = `trail-${vehicle.id}`;

        state.map.addSource(trailId, {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: {
              type: 'LineString',
              coordinates: [vehicle.currentCoords]
            }
          }
        });

        state.map.addLayer({
          id: `trail-layer-${vehicle.id}`,
          type: 'line',
          source: trailId,
          paint: {
            'line-color': vehicle.color === 'blue' ? '#2563eb' :
              vehicle.color === 'red' ? '#ef4444' : '#10b981',
            'line-width': 6,
            'line-opacity': 1
          }
        }, `route-layer-${vehicle.id}`); // Desenhar abaixo das rotas
      });
    }

    function updateTrail(vehicle) {
      const trailId = `trail-${vehicle.id}`;
      const source = state.map.getSource(trailId);

      if (source) {
        const trailCoords = [];

        // Adicionar todas as paradas j√° visitadas
        for (let i = 0; i < vehicle.currentStopIndex && i < vehicle.stops.length; i++) {
          trailCoords.push(vehicle.stops[i].coords);
        }

        // Adicionar posi√ß√£o atual
        trailCoords.push(vehicle.currentCoords);

        source.setData({
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: trailCoords
          }
        });
      }
    }

    // Criar marcadores com popups
    state.vehicles.forEach(vehicle => {
      const el = document.createElement('div');
      el.style.cssText = `
                width: 45px; height: 45px;
                background: ${vehicle.color === 'blue' ? '#2563eb' : vehicle.color === 'red' ? '#ef4444' : '#10b981'};
                border: 3px solid white;
                border-radius: 50%;
                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                cursor: pointer;
                transition: transform 0.2s;
            `;
      el.innerHTML = vehicle.icon;
      el.addEventListener('mouseenter', () => el.style.transform = 'scale(1.2)');
      el.addEventListener('mouseleave', () => el.style.transform = 'scale(1)');

      // MELHORIA 5: Adicionar popup interativo
      const popup = new mapboxgl.Popup({ offset: 25 })
        .setHTML(getVehiclePopupHTML(vehicle));

      const marker = new mapboxgl.Marker(el)
        .setLngLat(vehicle.currentCoords)
        .setPopup(popup)
        .addTo(state.map);

      state.markers[vehicle.id] = marker;
      vehicle.popup = popup; // Salvar refer√™ncia
    });

    // ============================================
    // MELHORIA 5: POPUP HTML DOS VE√çCULOS
    // ============================================
    function getVehiclePopupHTML(vehicle) {
      const nextStop = vehicle.currentStopIndex < vehicle.stops.length
        ? vehicle.stops[vehicle.currentStopIndex].name
        : 'Rota conclu√≠da';

      return `
        <div style="padding: 8px; min-width: 180px;">
            <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">
                ${vehicle.icon} VE√çCULO ${vehicle.id}
            </h4>
            <div style="font-size: 12px; line-height: 1.6;">
                <div><strong>Status:</strong> ${getStatus(vehicle)}</div>
                <div><strong>Destino:</strong> ${nextStop}</div>
                <div><strong>Velocidade:</strong> ${vehicle.speed} km/h</div>
                <div><strong>ETA:</strong> ${calculateETA(vehicle)}</div>
            </div>
        </div>
    `;
    }

    // Fun√ß√µes auxiliares
    function getTotalDistance(vehicle) {
      return vehicle.stops.reduce((sum, stop) => sum + stop.dist, 0);
    }

    function getDistanceTraveled(vehicle) {
      let traveled = 0;
      for (let i = 0; i < vehicle.currentStopIndex; i++) {
        traveled += vehicle.stops[i].dist;
      }
      if (vehicle.currentStopIndex < vehicle.stops.length) {
        traveled += vehicle.stops[vehicle.currentStopIndex].dist * (vehicle.progressInRoute / 100);
      }
      return traveled;
    }

    function getDistanceToNextStop(vehicle) {
      if (vehicle.currentStopIndex >= vehicle.stops.length) return 0;
      return vehicle.stops[vehicle.currentStopIndex].dist * (1 - vehicle.progressInRoute / 100);
    }

    function calculateETA(vehicle) {
      const distanceRemaining = getDistanceToNextStop(vehicle);
      if (vehicle.speed === 0) return 'Parado';
      if (distanceRemaining === 0) return 'Chegou';

      const minutesRemaining = Math.round((distanceRemaining / vehicle.speed) * 60);
      if (minutesRemaining < 1) return 'Chegando agora';
      if (minutesRemaining < 60) return `${minutesRemaining} min`;

      const hours = Math.floor(minutesRemaining / 60);
      const mins = minutesRemaining % 60;
      return `${hours}h ${mins}min`;
    }

    function getStatus(vehicle) {
      if (vehicle.currentStopIndex >= vehicle.stops.length) return 'Conclu√≠do ‚úÖ';
      if (vehicle.speed === 0) return vehicle.progressInRoute === 0 ? 'Aguardando üïê' : 'Parado üÖøÔ∏è';
      if (vehicle.progressInRoute > 90) return 'Chegando üìç';
      return 'Em tr√¢nsito üöö';
    }

    function updateVehicleCoordinates(vehicle) {
      if (vehicle.currentStopIndex >= vehicle.stops.length) return;

      const currentStop = vehicle.stops[vehicle.currentStopIndex];
      const progress = vehicle.progressInRoute / 100;

      const startCoords = vehicle.currentStopIndex === 0
        ? vehicle.stops[0].coords
        : vehicle.stops[vehicle.currentStopIndex - 1].coords;

      const endCoords = currentStop.coords;

      vehicle.currentCoords = [
        startCoords[0] + (endCoords[0] - startCoords[0]) * progress,
        startCoords[1] + (endCoords[1] - startCoords[1]) * progress
      ];
    }

    // ============================================
    // MELHORIA 3: MOVIMENTO SUAVE (100ms)
    // ============================================
    function updatePositions() {
      state.vehicles.forEach(vehicle => {
        if (vehicle.speed > 0 && vehicle.currentStopIndex < vehicle.stops.length) {
          const previousIndex = vehicle.currentStopIndex;

          // Incremento por 100ms (0.1 segundo)
          const incrementPerUpdate = (vehicle.speed / 3600) * 0.1;
          const currentStopDistance = vehicle.stops[vehicle.currentStopIndex].dist;

          // Atualizar progresso
          vehicle.progressInRoute += (incrementPerUpdate / currentStopDistance) * 100;

          updateVehicleCoordinates(vehicle);

          if (vehicle.progressInRoute >= 100) {
            vehicle.currentStopIndex++;
            vehicle.progressInRoute = 0;

            if (vehicle.currentStopIndex >= vehicle.stops.length) {
              vehicle.speed = 0;
              vehicle.progressInRoute = 100;
            }

            // MELHORIA 7: Notifica√ß√£o de chegada
            if (previousIndex < vehicle.currentStopIndex && previousIndex < vehicle.stops.length) {
              const arrivedStop = vehicle.stops[previousIndex];
              showNotification(
                `${vehicle.icon} Ve√≠culo ${vehicle.id} chegou em ${arrivedStop.name}!`,
                'success'
              );
            }
          }
        }
      });

      // Atualizar marcadores no mapa (sempre)
      state.vehicles.forEach(vehicle => {
        const marker = state.markers[vehicle.id];
        if (marker) {
          marker.setLngLat(vehicle.currentCoords);
        }
      });

      // Atualizar trails
      state.vehicles.forEach(vehicle => {
        updateTrail(vehicle);
      });

      // Atualizar popups
      state.vehicles.forEach(vehicle => {
        if (vehicle.popup) {
          vehicle.popup.setHTML(getVehiclePopupHTML(vehicle));
        }
      });

      // Renderizar UI apenas a cada 1 segundo (performance)
      if (!state.lastRender || Date.now() - state.lastRender > 1000) {
        render();
        state.lastRender = Date.now();
      }
    }

    // ============================================
    // MELHORIA 7: NOTIFICA√á√ïES TOAST
    // ============================================
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-left: 4px solid ${type === 'success' ? '#10b981' : '#2563eb'};
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        max-width: 300px;
        font-size: 14px;
        font-weight: 500;
    `;
      notification.textContent = message;

      document.body.appendChild(notification);

      // Remover ap√≥s 3 segundos
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function render() {
      const sidebar = document.getElementById('sidebar');

      // Atualizar m√©tricas do header
      updateHeaderMetrics();

      sidebar.innerHTML = `
                ${state.vehicles.map(vehicle => {
        const progress = Math.round(getDistanceTraveled(vehicle) / getTotalDistance(vehicle) * 100);
        const nextStop = vehicle.currentStopIndex < vehicle.stops.length
          ? vehicle.stops[vehicle.currentStopIndex].name
          : 'Rota conclu√≠da';

        return `
                        <div class="vehicle-card ${vehicle.color}">
                            <div class="vehicle-header">
                                <span class="vehicle-icon">${vehicle.icon}</span>
                                <span class="vehicle-name">VE√çCULO ${vehicle.id}</span>
                            </div>
                            <div class="vehicle-info">
                                <div class="${vehicle.speed > 0 ? 'status-active' : 'status-stopped'}">
                                    ${getStatus(vehicle)}
                                </div>
                                <div><strong>Destino:</strong> ${nextStop}</div>
                                ${getDistanceToNextStop(vehicle) > 0 ?
            `<div><strong>Dist√¢ncia:</strong> ${getDistanceToNextStop(vehicle).toFixed(1)} km</div>` : ''}
                                <div><strong>ETA:</strong> ${calculateETA(vehicle)}</div>
                                ${vehicle.speed > 0 ?
            `<div><strong>Velocidade:</strong> ${vehicle.speed} km/h</div>` : ''}
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                                <div class="progress-text">${progress}% conclu√≠do</div>
                            </div>
                            <div class="controls">
                                <button class="btn btn-secondary" onclick="toggleSpeed(${vehicle.id})">
                                    ${vehicle.speed > 0 ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Iniciar'}
                                </button>
                                <button class="btn btn-secondary" onclick="focusVehicle(${vehicle.id})">
                                    üéØ Focar
                                </button>
                            </div>
                        </div>
                    `;
      }).join('')}
                
                <div class="action-buttons">
                    <button class="btn btn-secondary btn-full" onclick="reset()">
                        üîÑ Reiniciar Simula√ß√£o
                    </button>
                </div>
            `;
    }

    // Atualizar m√©tricas do header dinamicamente
    function updateHeaderMetrics() {
      const activeVehicles = state.vehicles.filter(v => v.speed > 0).length;
      const totalVehicles = state.vehicles.length;
      const completedRoutes = state.vehicles.filter(v => v.currentStopIndex >= v.stops.length).length;

      const avgSpeed = state.vehicles.reduce((sum, v) => sum + v.speed, 0) / totalVehicles;

      const metricsHTML = `
        <div class="metric-card">
          <div class="metric-label">
            <span class="metric-label-icon">üöö</span>
            Ve√≠culos
          </div>
          <div class="metric-value ${activeVehicles > 0 ? 'status-active' : ''}">${activeVehicles}/${totalVehicles}</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">
            <span class="metric-label-icon">‚úÖ</span>
            Conclu√≠das
          </div>
          <div class="metric-value">${completedRoutes}</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">
            <span class="metric-label-icon">‚ö°</span>
            Vel. M√©dia
          </div>
          <div class="metric-value">${avgSpeed.toFixed(0)} km/h</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">
            <span class="metric-label-icon">üïê</span>
            Status
          </div>
          <div class="metric-value ${state.isActive ? 'status-active' : 'status-alert'}">${state.isActive ? 'Ativo' : 'Pausado'}</div>
        </div>
      `;

      document.getElementById('header-metrics').innerHTML = metricsHTML;

      // Atualizar bot√£o de tracking
      const trackingBtn = document.getElementById('tracking-btn');
      if (trackingBtn) {
        trackingBtn.innerHTML = `
          <span class="btn-header-icon">${state.isActive ? '‚èπÔ∏è' : '‚ñ∂Ô∏è'}</span>
          <span>${state.isActive ? 'Parar' : 'Iniciar'}</span>
        `;
      }
    }

    // Centralizar mapa
    function resetView() {
      state.map.flyTo({
        center: [-46.6611, -23.5705],
        zoom: 12,
        duration: 1500
      });
    }

    function toggleSpeed(vehicleId) {
      const vehicle = state.vehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        if (vehicle.speed > 0) {
          vehicle.speed = 0;
        } else {
          vehicle.speed = vehicle.baseSpeed;
        }
        render();
      }
    }

    function focusVehicle(vehicleId) {
      const vehicle = state.vehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        state.map.flyTo({
          center: vehicle.currentCoords,
          zoom: 14,
          duration: 1500
        });
      }
    }

    function resetView() {
      // Centralizar no centro de S√£o Paulo com todos os ve√≠culos vis√≠veis
      state.map.flyTo({
        center: [-46.6611, -23.5656],
        zoom: 11,
        duration: 1500
      });
    }

    function toggleTracking() {
      if (state.isActive) {
        clearInterval(state.interval);
        state.isActive = false;
      } else {
        state.isActive = true;
        state.interval = setInterval(updatePositions, 100); // 100ms para movimento suave
      }
      render();
    }

    function reset() {
      if (state.isActive) {
        clearInterval(state.interval);
        state.isActive = false;
      }

      state.vehicles = [
        {
          id: 1, color: 'blue', icon: 'üöô',
          currentStopIndex: 0, progressInRoute: 0, speed: 45, baseSpeed: 45,
          stops: [
            { name: 'Hospital das Cl√≠nicas', dist: 2.1, coords: [-46.6708, -23.5646] },
            { name: 'Hospital Einstein', dist: 3.2, coords: [-46.6750, -23.5990] },
            { name: 'Hospital S√≠rio-Liban√™s', dist: 1.8, coords: [-46.6532, -23.5673] }
          ],
          currentCoords: [-46.6708, -23.5646]
        },
        {
          id: 2, color: 'red', icon: 'üöó',
          currentStopIndex: 0, progressInRoute: 0, speed: 35, baseSpeed: 35,
          stops: [
            { name: 'Hospital Israelita', dist: 4.5, coords: [-46.6886, -23.5893] },
            { name: 'S√≠rio-Liban√™s', dist: 2.3, coords: [-46.6532, -23.5673] },
            { name: 'Hospital Alem√£o', dist: 3.1, coords: [-46.6610, -23.5987] }
          ],
          currentCoords: [-46.6886, -23.5893]
        },
        {
          id: 3, color: 'green', icon: 'üöê',
          currentStopIndex: 0, progressInRoute: 0, speed: 0, baseSpeed: 40,
          stops: [
            { name: 'Santa Casa', dist: 5.2, coords: [-46.6389, -23.5383] },
            { name: 'Hospital S√£o Paulo', dist: 2.8, coords: [-46.6422, -23.5980] },
            { name: 'Hospital 9 de Julho', dist: 4.1, coords: [-46.6681, -23.5533] }
          ],
          currentCoords: [-46.6389, -23.5383]
        }
      ];

      // Atualizar marcadores
      state.vehicles.forEach(vehicle => {
        const marker = state.markers[vehicle.id];
        if (marker) marker.setLngLat(vehicle.currentCoords);
      });

      render();
    }

    // Renderizar inicial
    render();

    // Iniciar rastreamento automaticamente
    setTimeout(() => toggleTracking(), 500);
  </script>
</body>

</html>
